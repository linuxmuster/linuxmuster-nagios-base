#!/bin/bash

# source linuxmuster-base-config
[ -f /usr/share/linuxmuster/config/dist.conf ] && . /usr/share/linuxmuster/config/dist.conf

# basedir holding configuration files for
# linuxmuster-nagios
LINUXMUSTERNAGIOSBASE=/var/lib/linuxmuster-nagios

# Nagiosconfigfiles
NAGIOSCONF=/etc/nagios3

# Getting basedn
basedn=`grep basedn $NETWORKSETTINGS | sed "s/^.*\"\(.*\)\".*$/\1/"`

# Getting Version 
VERSION=`head -n 1 /etc/issue  | cut -d' ' -f1,2 | tr -d '\n'`

case "$1" in
    configure)

        # First install on ubuntu
        distconf=`ls /etc/nagios3/conf.d/*nagios2.cfg > /dev/null 2>&1`
        if [ "x${distconf}" != "x" ]; then
           # remove distributed config
           rm /etc/nagios3/conf.d/* > /dev/null 2>&1
        fi
        
        # Upgrade fom nagios 2 to nagios 3
        if [ -d /etc/nagios2 ]; then
           # remove distributed config
           rm /etc/nagios3/conf.d/* > /dev/null 2>&1
           # copy lml conf for nagios3
	   cp -a $LINUXMUSTERNAGIOSBASE/custom_config/nagios3 /etc/
           rm /etc/nagios3/*.lenny-upgrade > /dev/null 2>&1
        fi

	# overwrite configuration with 
	# linuxmuster-nagios-default 
	# configuration
	cp -ar $LINUXMUSTERNAGIOSBASE/config/nagios3 /etc/

	# provide custom configuration file when necessary
	if [ ! -f /etc/nagios3/conf.d/linuxmuster_custom.cfg ]; then
	  cp -a $LINUXMUSTERNAGIOSBASE/custom_config/nagios* /etc/
	fi
	
        # provide resource.cfg if missing
	if [ ! -f /etc/nagios3/resource.cfg ]; then
	   touch /etc/nagios3/resource.cfg
           chmod 640 /etc/nagios3/resource.cfg
           chgrp nagios /etc/nagios3/resource.cfg
	fi
        # provide commands.cfg if missing
	if [ ! -f /etc/nagios3/commands.cfg ]; then
	   touch /etc/nagios3/commands.cfg
           chmod 640 /etc/nagios3/commands.cfg
           chgrp nagios /etc/nagios3/commands.cfg
	fi
        # remove defect nagios2 link in /etc/apache2/conf.d
        if [ -h /etc/apache2/conf.d/nagios2 ] || [ -h /etc/apache2/conf.d/nagios2.conf ]; then 
           rm -f /etc/apache2/conf.d/nagios2*
        fi
             
	
	# Fixing auth configuration in /etc/nagios3/apache2.conf
        sed -e "s/###basedn###/$basedn/" $LINUXMUSTERNAGIOSBASE/templates/apache2.conf.tpl > /etc/nagios3/apache2.conf

	# modifying suders file
	cp /etc/sudoers /etc/sudoers.linuxmuster.nagios
	sed '/# LML-NAGIOS-START/,/# LML-NAGIOS-END/ d' < /etc/sudoers.linuxmuster.nagios > /etc/sudoers
	rm /etc/sudoers.linuxmuster.nagios
	echo "# LML-NAGIOS-START" >> /etc/sudoers
	echo "# LML-NAGIOS: The following lines are automtically generated by" >> /etc/sudoers
	echo "# LML-NAGIOS: linuxmuster-nagios-setup. Do not edit!" >> /etc/sudoers
	echo "Cmnd_Alias  NAGIOS_CHECKS=/usr/lib/nagios/plugins/check_debian, \ " >> /etc/sudoers
	echo "                          /usr/lib/nagios/plugins/check_imaging,  \ " >> /etc/sudoers
	echo "                          /usr/lib/nagios/plugins/check_local_mysql,  \ " >> /etc/sudoers
	echo "                          /usr/lib/nagios/plugins/check_local_pgsql,  \ " >> /etc/sudoers
	echo "                          /usr/lib/nagios/plugins/check_cups"       >> /etc/sudoers
	echo "nagios  ALL=NOPASSWD: NAGIOS_CHECKS" >> /etc/sudoers
	echo "# LML-NAGIOS-END" >> /etc/sudoers
	#echo "# LML: If your own nagios plugins need sudo capabilities " >> /etc/sudoers
	#echo "# LML: uncomment and configure the following lines " >> /etc/sudoers
	#echo "#Cmnd_Alias  CUSTOM_NCHECKS=/path/to/command" >> /etc/sudoers
	#echo "#nagios  ALL=NOPASSWD: CUSTOM_NCHECKS" >> /etc/sudoers


	# Modifying permissions in /var/lib/nagios (debian bug in nagios 2.5)
	chmod 755 /var/lib/nagios3
	chmod 775 /var/lib/nagios3/rw
	chown nagios.www-data /var/lib/nagios3/rw
	chmod g+s /var/lib/nagios3/rw

	# fixing permissions for logs
	chmod 755 /var/log/nagios3
	chown nagios.root /var/log/nagios3
	chmod u+s /var/log/nagios3

	# Fixing perm for /etc/nagios3/conf.d - nagios has to own this dir for
	# nagios-grapher to work
	chown nagios /etc/nagios3/conf.d

        # removing nagios2 config if existent
        if [ -d /etc/nagios2 ]; then
           # backup nagios2 cfg
           tar -cvzf /etc/nagios3/nagios2.conf.backup.tgz /etc/nagios2/
           # remove nagios2 config
           rm -rf /etc/nagios2/ > /dev/null 2>&1
           rm -rf /etc/init.d/nagios2  > /dev/null 2>&1
           rm -rf /var/lib/linuxmuster-nagios/config/nagios2  > /dev/null 2>&1
	   rm -f /etc/rc5.d/S30nagios2 2>&1
	   rm -f /etc/rc1.d/K18nagios2 2>&1
	   rm -r /etc/default/nagios2 2>&1
	   rm -f /etc/rc2.d/S30nagios2 2>&1
	   rm -f /etc/logrotate.d/nagios2-common 2>&1
           rm -f /etc/rc3.d/S30nagios2 2>&1
	   rm -f /etc/rc0.d/K18nagios2 2>&1
	   rm -f /etc/rc6.d/K18nagios2 2>&1
	   rm -f /etc/rc4.d/S30nagios2 2>&1
	   rm -rf /var/lib/nagios2 2>&1
	   # configure nagios
	   /usr/sbin/linuxmuster-nagios-setup
        fi

	# tschmitt: do this only if linuxmuster is installed
	if [[ -n "$INSTALLED" && -e "$INSTALLED" ]]; then
                # patch LML Version to /etc/linuxmuster/nagios.conf
                sed -i "s/DESC_SERVER=\".*\"/DESC_SERVER=\"Server: ${VERSION}\"/"  /etc/linuxmuster/nagios.conf 
                sed -i "s/DESC_FW=\".*\"/DESC_FW=\"Firewall: ${VERSION}\"/"  /etc/linuxmuster/nagios.conf 
                sed -i "s/DESC_SERVERGROUP=\".*\"/DESC_SERVERGROUP=\"Server ${VERSION}\"/"  /etc/linuxmuster/nagios.conf 
                sed -i "s|/var/run/nagios2|/var/run/nagios3|"  /etc/passwd

		# configure nagios
		/usr/sbin/linuxmuster-nagios-setup

		# restarting nagios
		/etc/init.d/nagios3 stop
		/etc/init.d/nagios3 start

		# restarting apache2 webserver
		/etc/init.d/apache2 reload

	fi

	;;

    abort-upgrade|abort-remove|abort-deconfigure)

	;;

    *)
	echo "postinst called with unknown argument \`$1'" >&2
	exit 1
	;;

esac

exit 0
